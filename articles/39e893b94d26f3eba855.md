---
title: "Flutterã®è‡ªå‹•ãƒ“ãƒ«ãƒ‰ã‚’Github Actionsã¨Firebaseã§è¡Œã†"
emoji: "ğŸ¤–"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["Flutter", "CD", "GithubActions", "Firebase"]
published: true
---

[Flutter #3 ã‚¢ãƒ‰ãƒ™ãƒ³ãƒˆã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ 2020 - Qiita](https://qiita.com/advent-calendar/2020/flutter-3) ã®20æ—¥ç›®ã®è¨˜äº‹ã§ã™ã€‚

Flutterã§é–‹ç™ºä¸­ã¯ãƒ›ãƒƒãƒˆãƒªãƒ­ãƒ¼ãƒ‰ãŒä½¿ãˆã‚‹ãŸã‚ã€ãƒ“ãƒ«ãƒ‰ã«å›°ã‚‹ã“ã¨ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚

ã—ã‹ã—ã€ã„ã–å®Ÿæ©Ÿã§ç¢ºèªã—ã‚ˆã†ã¨æ€ã†ã¨ãƒ“ãƒ«ãƒ‰æ‰‹é †ã‚’å¿˜ã‚ŒãŸã‚Šã€ãƒ“ãƒ«ãƒ‰ã«æ™‚é–“ãŒã‹ã‹ã£ã¦ä½œæ¥­ã®æ‰‹ãŒæ­¢ã¾ã‚‹ã“ã¨ãŒå¤šã€…ã‚ã‚‹ã‹ã¨æ€ã„ã¾ã™ã€‚

ä»Šå›ã¯ãã‚Œã‚’è§£æ¶ˆã™ã‚‹ãŸã‚ã«ã€Flutterã®CDç’°å¢ƒã‚’Github Actionsã¨Firebase App Distributionã‚’æ´»ç”¨ã—ã¦æº–å‚™ã—ã¾ã—ãŸã€‚

## å‰æ

1. ã‚³ãƒ¼ãƒ‰ã®ãƒªãƒã‚¸ãƒˆãƒªç®¡ç†ã‚’GitHubã§è¡Œã£ã¦ã„ã‚‹
1. Flutterã«Firebaseã‚’çµ„ã¿è¾¼ã‚“ã§ã„ã‚‹

:::message
Firebaseã‚’çµ„ã¿è¾¼ã‚“ã§ãªã„å ´åˆã«ã¯ã€Bitriseã‚’ä½¿ã†ã»ã†ãŒè‰¯ã„ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚
:::

## çµè«–

å®Ÿéš›ã«ã‚µãƒ³ãƒ—ãƒ«ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¨ã—ã¦ä½œã£ãŸã‚³ãƒ¼ãƒ‰ã‚’è¼‰ã›ã¦ãŠãã¾ã™ã€‚

https://github.com/qst-exe/flutter-firebase-cd


### iOSã®è‡ªå‹•ãƒ“ãƒ«ãƒ‰

```yml:ios.yml
name: iOS CD

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    # iOSãƒ“ãƒ«ãƒ‰ç”¨ã«macOSã‚’ä½¿ã†(æ¶ˆè²»ãƒ“ãƒ«ãƒ‰æ™‚é–“ã«æ³¨æ„)
    runs-on: macos-latest

    steps:
      - uses: actions/checkout@v2

      # ProvisioningProfile ã‚’ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‹ã‚‰å–ã‚Šå‡ºã—ã¦ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«ç„¡ç†ã‚„ã‚Šã‚»ãƒƒãƒˆã™ã‚‹
      - name: Import Provisioning Profile
        run: |
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          echo '${{ secrets.PROVISIONING_PROFILE }}' | openssl base64 -d -out ~/Library/MobileDevice/Provisioning\ Profiles/flutter_app_store.mobileprovision

      # è¨¼æ˜æ›¸ã‚’è¨­å®š
      - name: Import Code-Signing Certificates
        uses: Apple-Actions/import-codesign-certs@v1
        with:
          p12-file-base64: ${{ secrets.CERTIFICATES_P12 }}
          p12-password: ${{ secrets.CERTIFICATES_P12_PASSWORD }}

      - name: install flutter
        uses: subosito/flutter-action@v1
        with:
          flutter-version: '1.24.0-10.2.pre'
          channel: 'beta'

      - name: flutter dependencies install
        run: flutter pub get

      - name: build ipa
        run: flutter build ios --release --no-codesign

      - name: iOS Build Action
        uses: yukiarrr/ios-build-action@v0.5.0
        with:
          project-path: ios/Runner.xcodeproj
          p12-base64: ${{ secrets.CERTIFICATES_P12 }}
          mobileprovision-base64: ${{ secrets.PROVISIONING_PROFILE }}
          code-signing-identity: Apple Distribution
          team-id: ${{ secrets.TEAM_ID }}
          workspace-path: ios/Runner.xcworkspace
          certificate-password: ${{ secrets.CERTIFICATES_P12_PASSWORD }}
          output-path: app-release.ipa

      - name: Upload artifact
        uses: actions/upload-artifact@v1.0.0
        with:
          name: ios
          path: app-release.ipa

  deploy:
    needs: [build]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2

      # ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
      - name: Download artifact
        uses: actions/download-artifact@v1.0.0
        with:
          name: ios

      # Firebase ã«ãƒ‡ãƒ—ãƒ­ã‚¤
      - name: Firebase App Distribution
        uses: wzieba/Firebase-Distribution-Github-Action@v1.2.1
        with:
          appId: ${{secrets.FIREBASE_APP_ID_IOS}}
          token: ${{secrets.FIREBASE_TOKEN}}
          groups: testers
          file: ios/app-release.ipa
```

### Androidã®è‡ªå‹•ãƒ“ãƒ«ãƒ‰

```yml:android
name: Android CD

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2
      - name: install java 8.x
        uses: actions/setup-java@v1
        with:
          java-version: '8.x'

      - name: setup cache
        uses: actions/cache@v1
        with:
          path: /Users/runner/hostedtoolcache/flutter
          key: ${{ runner.OS }}-flutter-install-cache

      - name: install flutter
        uses: subosito/flutter-action@v1
        with:
          flutter-version: '1.24.0-10.2.pre'
          channel: 'beta'

      - name: flutter dependencies install
        run: flutter pub get

      - name: build apk
        run: |
          echo '${{ secrets.KEYSTORE_BASE64 }}' | base64 -d > android/release.keystore
          export KEYSTORE_PASSWORD='${{ secrets.KEYSTORE_PASSWORD }}'
          export KEY_ALIAS='${{ secrets.KEY_ALIAS }}'
          export KEY_PASSWORD='${{ secrets.KEY_PASSWORD }}'
          flutter build apk --release

      - name: Upload artifact
        uses: actions/upload-artifact@v1.0.0
        with:
          name: android
          path: build/app/outputs/flutter-apk/app-release.apk

  deploy:
    needs: [build]
    runs-on: ubuntu-latest
    steps:

      - uses: actions/checkout@v2

      # ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
      - name: Download artifact
        uses: actions/download-artifact@v1.0.0
        with:
          name: android

      # Firebase ã«ãƒ‡ãƒ—ãƒ­ã‚¤
      - name: Firebase App Distribution
        uses: wzieba/Firebase-Distribution-Github-Action@v1.2.1
        with:
          appId: ${{secrets.FIREBASE_APP_ID_ANDROID}}
          token: ${{secrets.FIREBASE_TOKEN}}
          groups: testers
          file: android/app-release.apk
```

## ãªãœGithub Actionsã¨Firebase App Distributionãªã®ã‹

ä»¥å‰ã¯ [Bitrise](https://www.bitrise.io/) ã‚’åˆ©ç”¨ã—ã¦ã„ãŸã®ã§ã™ãŒã€

- Xcodeã®ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆæ™‚ã«ãƒ“ãƒ«ãƒ‰ãŒæ­¢ã¾ã‚‹(å¯¾å¿œã¯ã™ãã«ã—ã¦ãã‚Œã¾ã—ãŸ)
- Flutterã«Firebaseã‚’çµ„ã¿è¾¼ã‚“ã æ™‚ã«ãƒ“ãƒ«ãƒ‰æ™‚é–“ãŒå¤§å¹…ã«ã‹ã‹ã£ã¦æ–™é‡‘ãŒä¸ŠãŒã£ã¦ã—ã¾ã†

ã¨ã„ã†ç‚¹ãŒã‚ã£ãŸã®ã§Bitriseä»¥å¤–ã®ä»¥å¤–ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚’æ¢ã—ãŸã¨ã“ã‚

1. ãƒªãƒã‚¸ãƒˆãƒªã®ç®¡ç†ã«GitHubã‚’ä½¿ã£ã¦ã„ãŸ
1. Firebaseã‚’ã‚¢ãƒ—ãƒªã«çµ„ã¿è¾¼ã‚“ã§ã„ãŸ

ã¨ã„ã†çŠ¶æ³ã§ã€GitHub Actionsã¨Firebase App Distributionã§CDç’°å¢ƒãŒæ§‹ç¯‰ã§ãã‚‹ã“ã¨ã‚’çŸ¥ã‚Šã€ã“ã®2ã¤ã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ã«ã—ã¾ã—ãŸã€‚


## Flutterã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«ã¤ã„ã¦

ä»Šã¯ `beta` ãƒãƒ£ãƒ³ãƒãƒ«ã§é–‹ç™ºã‚’é€²ã‚ã¦ã„ã‚‹ã®ã§ã€ãƒ“ãƒ«ãƒ‰ã‚‚ `beta` ã‚’ä½¿ã£ã¦ã„ã¾ã™ã€‚
 
 `stable` ãŒè‰¯ã„äººã¯ `install flutter` ã®ç®‡æ‰€ã§é©å®œé©åˆ‡ãªç’°å¢ƒã‚’è¨­å®šã™ã‚‹ã¨è‰¯ã„ã§ã—ã‚‡ã†ã€‚

```
flutter-version: '1.24.0-10.2.pre'
channel: 'beta'
```

## Firebase App Distributionåˆ©ç”¨ã®ã†ãˆã§ã®æ³¨æ„

Firebase App Distributionã‚’åˆ©ç”¨ã™ã‚‹ã†ãˆã§é€šå¸¸ã®ãƒ“ãƒ«ãƒ‰ã¨ã¯é•ã†ç’°å¢ƒå¤‰æ•°ãŒå¿…è¦ã«ãªã‚‹ã®ã§ã€è¨˜è¼‰ã—ã¦ãŠãã¾ã™ã€‚

### FIREBASE_TOKEN

ã“ã¡ã‚‰ã¯ã€[Firebase CLI](https://firebase.google.com/docs/cli?hl=ja) ã§ãƒ­ã‚°ã‚¤ãƒ³ã—ãŸã¨ãã«tokenãŒè¡¨ç¤ºã•ã‚Œã‚‹ã®ã§ã€

```
firebase login:ci
```

ã‚’å®Ÿè¡Œã—ã¦tokenã‚’å–å¾—ã™ã‚Œã°å¤§ä¸ˆå¤«ã§ã™ã€‚

```
Visit this URL on this device to log in:

Waiting for authentication...

âœ”  Success! Use this token to login on a CI server:

(ã“ã“ã«tokenãŒè¡¨ç¤ºã•ã‚Œã¾ã™)

Example: firebase deploy --token "$FIREBASE_TOKEN"
```

### FIREBASE_APP_ID_IOS, IREBASE_APP_ID_ANDROID  

ã“ã¡ã‚‰ã¯Firebaseã¨iOS,Androidã®ã‚¢ãƒ—ãƒªã‚’é€£æºã—ãŸã¨ãã«è¡¨ç¤ºã•ã‚Œã‚‹IDã§ã™ã€‚(Bundle IDã‚„Package Nameã§ã¯ã‚ã‚Šã¾ã›ã‚“)

Firebaseã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã®è¨­å®šç”»é¢ã‹ã‚‰ç¢ºèªã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/3pbi9nph6eae492l37ojcb8o2chv)

## é–‹ç™ºç’°å¢ƒã®åˆ‡ã‚Šæ›¿ãˆ

ã‚µãƒ³ãƒ—ãƒ«ã«ã¯è¨˜è¼‰ã—ã¦ã„ã¾ã›ã‚“ãŒã€å®Ÿéš›ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã¯ã€é–‹ç™ºç’°å¢ƒã€ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒã€æœ¬ç•ªç’°å¢ƒã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹å¿…è¦ãŒã‚ã£ãŸã®ã§ã€monoã•ã‚“ã®è¨˜äº‹ã‚’å‚è€ƒã« `flavor` ã§ç’°å¢ƒã‚’åˆ‡ã‚Šåˆ†ã‘ã‚‰ã‚Œã‚‹ã‚ˆã†ã«ã—ã¾ã—ãŸã€‚

https://medium.com/flutter-jp/flavor-b952f2d05b5d

ãã®ãŸã‚ã€å®Ÿéš›ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã¯ `build apk` `build ipa` ã§å®Ÿè¡Œã™ã‚‹ãƒ“ãƒ«ãƒ‰ã‚³ãƒãƒ³ãƒ‰ã‚’

```
flutter build apk --release --flavor staging
```

ã¨ã„ã†ã‚ˆã†ã«è¨­å®šã—ã¦ã„ã¦ã„ã¾ã™ã€‚

å„ç’°å¢ƒã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã¯ `main` ã®ã¨ã“ã‚ã‚’å¯¾å¿œã™ã‚‹ãƒ–ãƒ©ãƒ³ãƒåã«å¤‰ãˆã‚‹ã“ã¨ã§å¯¾å¿œã—ã¾ã—ãŸã€‚

```
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
```

## èª²é¡Œ

ã“ã®æ–¹æ³•ã§CDç’°å¢ƒã‚’ä½œã£ãŸã¨ãã«å›°ã£ãŸã“ã¨ã§ã™ã€‚

1. iOSã®å ´åˆã€macOSã§ã®ãƒ“ãƒ«ãƒ‰ã§ã‚ã‚Šã€privateãƒªãƒã‚¸ãƒˆãƒªã®å ´åˆã«ã¯ã™ãã«ãƒ“ãƒ«ãƒ‰æ™‚é–“ã‚’æ¶ˆè²»ã—ã¦ã—ã¾ã†(masOSã¯ãƒ“ãƒ«ãƒ‰æ¶ˆè²»æ™‚é–“ãŒubuntuã®10å€ã®ãŸã‚)
1. åŒæ§˜ã®ç†ç”±ã§ã€iOSã®CDã®ãƒ†ã‚¹ãƒˆã‚’ã—ã‚ˆã†ã¨æ€ã£ãŸã¨ãã«ã¯[act](https://github.com/nektos/act)ãŒä½¿ãˆãªã„ãŸã‚ã€éƒ½åº¦GitHub Actionsã‚’å®Ÿè¡Œã™ã‚‹å¿…è¦ãŒã‚ã‚‹

https://docs.github.com/ja/free-pro-team@latest/github/setting-up-and-managing-billing-and-payments-on-github/about-billing-for-github-actions#github-actions%E3%81%AE%E6%94%AF%E6%89%95%E3%81%84%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6

https://github.com/nektos/act

ã“ã‚Œã‚‰ã®èª²é¡ŒãŒè§£æ±ºã¾ãŸã¯æ–°ãŸãªèª²é¡ŒãŒå‡ºã¦ãæ¬¡ç¬¬æ›´æ–°ã—ã¦ã„ã“ã†ã¨æ€ã„ã¾ã™ã€‚

æœ€å¾Œã¾ã§èª­ã‚“ã§ã„ãŸã ã„ã¦ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸï¼
